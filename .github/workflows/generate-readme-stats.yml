name: Generate README Stats

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 0'

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      USERNAME: VLADos-IT
      PORT: 3000
      PAT_1: ${{ secrets.PAT_1 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Generate stats SVGs (tokyonight)
        run: |
          set -e
          git clone --depth 1 https://github.com/anuraghazra/github-readme-stats.git generator
          cd generator
          npm ci --prefer-offline --no-audit --no-fund
          
          node express.js > ../server.log 2>&1 &
          SERVER_PID=$!
          
          sleep 5
          
          cd ..
          rm -rf assets/readme-stats/*.svg
          mkdir -p assets/readme-stats
          
          S_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          echo "SHORT_SHA=${S_SHA}" >> $GITHUB_ENV

          curl -fsS "http://localhost:${PORT}/api?username=${USERNAME}&show_icons=true&theme=tokyonight" -o "assets/readme-stats/stats-${S_SHA}.svg"
          curl -fsS "http://localhost:${PORT}/api/top-langs?username=${USERNAME}&layout=compact&theme=tokyonight" -o "assets/readme-stats/top-langs-${S_SHA}.svg"
          
          ls -l assets/readme-stats/
          
          kill "${SERVER_PID}" || true

      - name: Update README
        run: |
          REPO="${GITHUB_REPOSITORY}"
          BRANCH="${GITHUB_REF_NAME}"
          SHA="${{ env.SHORT_SHA }}"
          
          NEW_STATS="https://raw.githubusercontent.com/${REPO}/${BRANCH}/assets/readme-stats/stats-${SHA}.svg"
          NEW_LANGS="https://raw.githubusercontent.com/${REPO}/${BRANCH}/assets/readme-stats/top-langs-${SHA}.svg"

          sed -i -E "s|https://raw.githubusercontent.com/${REPO}/[^/]*/assets/readme-stats/stats-[^.]+\.svg|${NEW_STATS}|g" README.md
          sed -i -E "s|https://raw.githubusercontent.com/${REPO}/[^/]*/assets/readme-stats/top-langs-[^.]+\.svg|${NEW_LANGS}|g" README.md
          git add assets/readme-stats/*.svg README.md

      - name: Commit and Push
        uses: planetscale/ghcommit-action@v0.2.18
        with:
          commit_message: "chore: update readme stats ${{ env.SHORT_SHA }} [skip ci]"
          repo: ${{ github.repository }}
          branch: ${{ github.ref_name }}
          file_pattern: 'assets/readme-stats/*.svg README.md'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
